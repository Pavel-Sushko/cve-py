import modules.api as api
import json
import os
from datetime import datetime


def get_vulnerabilities(date):
    if not os.path.isfile(f'data/{date.year}/{date.month}/{date.day}.json'):
        return None

    with open(f'data/{date.year}/{date.month}/{date.day}.json', 'r') as f:
        return json.load(f)


def write_vulnerabilities(vulnerabilities):
    split_vulnerabilities = split_vulnerabilities_by_date(vulnerabilities)

    for date, vulnerabilities in split_vulnerabilities.items():
        if not os.path.isdir(f'data/{date.year}/{date.month}'):
            os.makedirs(f'data/{date.year}/{date.month}')

        with open(f'data/{date.year}/{date.month}/{date.day}.json', 'w') as f:
            json.dump(vulnerabilities, f)


def split_vulnerabilities_by_date(vulnerabilities):
    split_vulnerabilities = {}

    for vulnerability in vulnerabilities:
        date = datetime.strptime(
            vulnerability['Published'], '%Y-%m-%dT%H:%M:%S.%fZ')

        if date not in split_vulnerabilities:
            split_vulnerabilities[date] = []

        split_vulnerabilities[date].append(vulnerability)

    return split_vulnerabilities


if __name__ == '__main__':
    vulnerabilities = get_vulnerabilities(datetime.now())

    print(vulnerabilities)
